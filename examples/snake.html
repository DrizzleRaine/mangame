<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Snake | Mangame</title>
<link rel="stylesheet" type="text/css" href="css/examples.css" />
<script type="text/javascript" src="js/util.js"></script>
<script type="text/javascript" src="../src/mangame.js"></script>
<script type="text/javascript">

window.onload = function() {

    var canvas = new Canvas("canvas");
    var game = new Game(canvas, {require: ['geom', 'ui']});
    game.onLoad = function() {

        var SnakeGame = Scene2D.extend({

            init: function(game) {
                this._super(game);
                this.x = 150;
                this.y = 150;
                this.dx = 1;
                this.dy = 0;
                this.pieceSize = 10;
                this.lastUpdate = 0;
                this.initLength = 3;
                this.fruitsCount = 0;
                this.fruitsToInc = 3;
                this.alive = true;
                this.pieces = [];
                this.fruit = this._createFruit();
                this.pieces.push(this._createPiece(this.x, this.y));
                for (var i = 1; i < this.initLength; i++) {
                    this.pieces.push(this._createPiece(this.x - this.pieceSize * i, this.y));
                }
                this.add(this.pieces);
                this.add(this.fruit);
                var self = this;
                game.addEventListener(Keyboard.KEY_DOWN, function(e) {
                    var key = e.originalEvent.keyCode;
                    if (key === 37 || key === 39 || key === 38 || key === 40) {
                        e.originalEvent.preventDefault(); // prevent scroll
                        if (self.dx === 0 && (key === 37 || key === 39)) {
                            self.dx = (key === 37) ? -1 : 1;
                            self.dy = 0;
                        }
                        if (self.dy === 0 && (key === 38 || key === 40)) {
                            self.dy = (key === 38) ? -1 : 1;
                            self.dx = 0;
                        }
                    }
                });
            },
            
            _createPiece: function(x, y) {
                var rect = new Rectangle(this.game.canvas, x, y, this.pieceSize, this.pieceSize);
                return rect;
            },
            
            _createFruit: function() {
                var pos = this._fruitPos();
                var rect = new Rectangle(this.game.canvas, pos.x(), pos.y(), this.pieceSize, this.pieceSize);
                return rect;
            },
                    
            _fruitPos: function() {
                return new Point(
                    Math.ceil(Math.random() * this.game.canvas.width()),
                    Math.ceil(Math.random() * this.game.canvas.height())
                );
            },
            
            onUpdate: function(elapsedTime) {
                if (this.alive) {
                    this.lastUpdate += elapsedTime;
                    if (this.lastUpdate > 100) {
                        var x = this.x + this.dx * this.pieceSize;
                        var y = this.y + this.dy * this.pieceSize;
                        if ((this.dx > 0 && x >= this.game.canvas.width() || this.dx < 0 && x < 0) ||
                            (this.dy > 0 && y >= this.game.canvas.height() || this.dy < 0 && y < 0)) {
                            this.alive = false;
                        }
                        if (x >= 0 && x <= this.game.canvas.width() - this.pieceSize) {
                            this.x = x;
                        }
                        if (y >= 0 && y <= this.game.canvas.height() - this.pieceSize) {
                            this.y = y;
                        }
                        for (var i = this.pieces.length - 1; i > 0; i--) {
                            var piece = this.pieces[i];
                            var next = this.pieces[i - 1];
                            piece.pos().x(next.pos().x());
                            piece.pos().y(next.pos().y());
                        }
                        var head = this.pieces[0]
                        head.pos().x(this.x);
                        head.pos().y(this.y);
                        if (head.collision(this.fruit)) {
                            this.fruitsCount++;
                            // increment the snake
                            if (this.fruitsCount > 0 && this.fruitsCount % this.fruitsToInc === 0) {
                                this.pieces.push(this._createPiece(this.x, this.y));
                                this.add(this.pieces[this.pieces.length - 1]);
                            }
                            var newPos;
                            var validPos;
                            do {
                                validPos = true;
                                newPos = this._fruitPos();
                                for (var i = 0; i < this.pieces.length; i++) {
                                    if (this.pieces[i].collision(newPos)) {
                                        validPos = false;
                                        break;
                                    }
                                }
                                this.fruit.pos().x(newPos.x());
                                this.fruit.pos().y(newPos.y());
                            } while (!validPos);
                        }
                        this.lastUpdate = 0;
                    }
                }
            }
        });
        game.showFps = true;
        game.addScene(new SnakeGame(game));
        game.play();
    }

}
</script>
</head>
<body>
    <div id="example" class="keyboard">
        <h1><a href="https://github.com/rogeriolino/mangame" title="goto project">MANGAME</a></h1>
        <h2>Snake example</h2>
        <div class="canvas-frame">
            <canvas id="canvas">
                <p>Your browser doesn't support HTML5 Canvas</p>
            </canvas>
            <div class="description">
                <p>Simple snake game example</p>
            </div>
        </div>
    </div>
</html>
